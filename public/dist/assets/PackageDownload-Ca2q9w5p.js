import{K as p,y as T,u as W,a$ as x,o,X as I,bV as L,W as _,F as M,V as O,aJ as P,aL as V,aM as A,S as D,ci as H,cH as J,b5 as g,cI as Z,_ as q}from"./index-CsB5zT4W.js";import{s as k}from"./StreamSaver-ISsQe9xL.js";k.mitm="/streamer/mitm.html";const K=m=>m.replace(/^\/+|\/+$/g,"");let S=0;const j=m=>{const a=T(),[$,l]=p(a("home.package_download.initializing")),[b,u]=p(0),{pathname:f,isShare:y}=W(),h=x(),w=async(e,s)=>{var d;if(s.is_dir){let c=g(f(),e,s.name);c.startsWith("/@tenant/data")&&(c=c.substring(13)||"/");const i=await Z(c,q());if(i.code!==200)return i.message;const n=[];for(const t of(d=i.data.content)!=null?d:[]){const r=await w(g(e,s.name),t);if(typeof r=="string")return r;n.push(...r)}return n}else return S+=s.size,[{path:g(e,s.name),url:J(g(f(),e),s,"direct",y(),!0)}]},[F,v]=p([]);return(async()=>{let e=H(f());h.length===1&&(e=h[0].name),e||(e=a("manage.sidemenu.home"));let s=k.createWriteStream("".concat(e,".zip"),{size:S});l(a("home.package_download.fetching_struct")),u(2);const d=[];for(const n of h){const t=await w("",n);if(typeof t=="string")return l("".concat(a("home.package_download.fetching_struct_failed"),": ").concat(t)),u(1),t;d.push(...t)}l(a("home.package_download.downloading")),u(3);let c=d.values(),i=new window.ZIP({pull(n){const t=c.next();if(t.done)n.close();else{let r=K(t.value.path);h.length===1&&(r=r.replace("".concat(e,"/"),""));const z=t.value.url;return fetch(z).then(B=>{v(C=>[...C,r]),n.enqueue({name:r,stream:B.body})})}}});if(window.WritableStream&&i.pipeTo)return i.pipeTo(s).then(()=>{l("".concat(a("home.package_download.success"))),u(4)}).catch(n=>{l("".concat(a("home.package_download.failed"),": ").concat(n)),u(1)})})(),[o(P,{get children(){return o(I,{w:"$full",alignItems:"start",spacing:"$2",get children(){return[o(L,{get children(){return[_(()=>a("home.package_download.current_status")),": ",_(()=>$())]}}),o(M,{get each(){return F()},children:e=>o(O,{css:{wordBreak:"break-all"},get children(){return["Fetching: ",e]}})})]}})}}),o(D,{get when(){return[1,4].includes(b())},get children(){return o(V,{get children(){return o(A,{colorScheme:"info",get onClick(){return m.onClose},get children(){return a("global.close")}})}})}})]};export{j as default};
