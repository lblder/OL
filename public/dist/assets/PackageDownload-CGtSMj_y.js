import{K as p,y as T,u as x,a$ as I,o as r,X as L,bV as M,W as _,F as O,V,aJ as W,aL as A,aM as D,S as H,ci as J,cH as P,b5 as m,cI as Z,_ as q}from"./index-CsB5zT4W.js";import{s as k}from"./StreamSaver-ISsQe9xL.js";k.mitm="/streamer/mitm.html";const K=g=>g.replace(/^\/+|\/+$/g,"");let S=0;const j=g=>{const a=T(),[$,o]=p(a("home.package_download.initializing")),[y,c]=p(0),{pathname:f,isShare:b}=x(),d=I(),w=async(e,n)=>{var i;if(n.is_dir){const l=await Z(m(f(),e,n.name),q());if(l.code!==200)return l.message;const u=[];for(const s of(i=l.data.content)!=null?i:[]){const t=await w(m(e,n.name),s);if(typeof t=="string")return t;u.push(...t)}return u}else return S+=n.size,[{path:m(e,n.name),url:P(m(f(),e),n,"direct",b(),!0)}]},[F,v]=p([]);return(async()=>{let e=J(f());d.length===1&&(e=d[0].name),e||(e=a("manage.sidemenu.home"));let n=k.createWriteStream("".concat(e,".zip"),{size:S});o(a("home.package_download.fetching_struct")),c(2);const i=[];for(const s of d){const t=await w("",s);if(typeof t=="string")return o("".concat(a("home.package_download.fetching_struct_failed"),": ").concat(t)),c(1),t;i.push(...t)}o(a("home.package_download.downloading")),c(3);let l=i.values(),u=new window.ZIP({pull(s){const t=l.next();if(t.done)s.close();else{let h=K(t.value.path);d.length===1&&(h=h.replace("".concat(e,"/"),""));const z=t.value.url;return fetch(z).then(B=>{v(C=>[...C,h]),s.enqueue({name:h,stream:B.body})})}}});if(window.WritableStream&&u.pipeTo)return u.pipeTo(n).then(()=>{o("".concat(a("home.package_download.success"))),c(4)}).catch(s=>{o("".concat(a("home.package_download.failed"),": ").concat(s)),c(1)})})(),[r(W,{get children(){return r(L,{w:"$full",alignItems:"start",spacing:"$2",get children(){return[r(M,{get children(){return[_(()=>a("home.package_download.current_status")),": ",_(()=>$())]}}),r(O,{get each(){return F()},children:e=>r(V,{css:{wordBreak:"break-all"},get children(){return["Fetching: ",e]}})})]}})}}),r(H,{get when(){return[1,4].includes(y())},get children(){return r(A,{get children(){return r(D,{colorScheme:"info",get onClick(){return g.onClose},get children(){return a("global.close")}})}})}})]};export{j as default};
