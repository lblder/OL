import{u as S,K as P,dS as I,P as f,a9 as L,ab as D,ad as A,aK as b,o as h,Q as H,S as j,O as B,y as K,c7 as R,d_ as F}from"./index-CsB5zT4W.js";var M=A("<div id=heic-container><canvas>");const N=()=>{const _=K(),{to:y}=S(),[w,i]=P(!0),[u,l]=P(!1),{libHeifPath:p}=I();let a=f.objs.filter(e=>/\.(heic|heif|avif|vvc|avc|jpeg|jpg)$/i.test(e.name));a.length===0&&(a=[f.obj]);const g=e=>{const t=a.findIndex(r=>r.name===f.obj.name);e.key==="ArrowLeft"&&t>0?y(a[t-1].name):e.key==="ArrowRight"&&t<a.length-1&&y(a[t+1].name)};let c,d,s;L(()=>{window.addEventListener("keydown",g),x()}),D(()=>{window.removeEventListener("keydown",g),c&&d&&(d=null),c=null});const x=async()=>{i(!0),l(!1);try{window.libheif||await C("".concat(p(),"/libheif.js"),"libheif-script");const e=await E("".concat(p(),"/libheif.wasm"));c=window.libheif({wasmBinary:e}),d=new c.HeifDecoder,await $(f.raw_url)}catch(e){console.error("HEIC初始化失败:",e),l(!0),i(!1)}},C=(e,t)=>new Promise((r,n)=>{const o=document.createElement("script");o.src=e,o.id=t,o.onload=()=>r(),o.onerror=()=>n("脚本加载失败: ".concat(e)),document.head.appendChild(o)}),E=async e=>{const t=await fetch(e);if(!t.ok)throw"WASM加载失败: ".concat(e);return await t.arrayBuffer()},$=async e=>{try{i(!0),l(!1);const t=await fetch(e);if(!t.ok)throw"文件获取失败";const r=await t.arrayBuffer(),n=d.decode(r);if(!n||n.length===0)throw"没有可解码的图像";const o=n[0];await k(o),i(!1)}catch(t){console.error("HEIC解码失败:",t),l(!0),i(!1)}},k=e=>new Promise(t=>{if(!s)return t();const r=e.get_width(),n=e.get_height();s.width=r,s.height=n;const o=new ImageData(r,n);e.display(o,m=>{if(!m||!s)return t();const v=s.getContext("2d");if(!v)return t();v.putImageData(m,0,0),t()})});return(()=>{var e=M(),t=e.firstChild;e.style.setProperty("position","relative"),e.style.setProperty("width","100%"),e.style.setProperty("height","75vh"),e.style.setProperty("display","flex"),e.style.setProperty("justify-content","center"),e.style.setProperty("align-items","center"),e.style.setProperty("overflow","hidden");var r=s;return typeof r=="function"?F(r,t):s=t,t.style.setProperty("max-width","100%"),t.style.setProperty("max-height","100%"),t.style.setProperty("object-fit","contain"),b(e,h(j,{get when(){return w()},get children(){return h(H,{})}}),null),b(e,h(j,{get when(){return u()},get children(){return h(B,{get msg(){return _("preview.failed_load_heic")},h:"75vh"})}}),null),R(n=>(n=w()||u()?"none":"block")!=null?t.style.setProperty("display",n):t.style.removeProperty("display")),e})()};export{N as default};
