import{_ as K,bi as N,P as E,u as ee,j as te,K as D,bN as ae,o as t,S as R,bg as V,X as _,bV as W,y as q,a2 as re,bk as ne,ac as I,ai as G,V as x,cj as oe,b1 as z,bh as se,am as M,aM as J,F as le,ck as ie,W as ce,cl as de,cm as ue,cn as pe,b5 as ge}from"./index-CsB5zT4W.js";import{a as me,b as he}from"./index-LqbMjJST.js";import{c as fe,a as we,b as ke,d as be}from"./index.esm-YAsqhZv0.js";const $e={pending:"neutral",uploading:"info",backending:"info",success:"success",error:"danger"},ye=async r=>{let l=[];const i=async(c,m)=>{await new Promise((p,g)=>{const u=o=>{console.error(o),g(o)};if(c.isFile)c.file(o=>{const n=new File([o],m+o.name,{type:o.type});l.push(n),console.log(n),p({})},u);else if(c.isDirectory){const o=c.createReader(),n=()=>{o.readEntries(async s=>{for(let d=0;d<s.length;d++)await i(s[d],m+c.name+"/");p({}),s.length>0&&n()},u)};n()}})};return await i(r,""),l},Fe=r=>({name:r.name,path:r.webkitRelativePath?r.webkitRelativePath:r.name,size:r.size,progress:0,speed:0,status:"pending"}),Q=async r=>{const l=await fe(),i=await we(),c=await ke(),m=r.stream().getReader(),w=async()=>{const{done:o,value:n}=await m.read();o||(l.update(n),i.update(n),c.update(n),await w())};await w();const p=l.digest("hex"),g=i.digest("hex"),u=c.digest("hex");return{md5:p,sha1:g,sha256:u}},Se=async(r,l,i,c=!1,m=!1,w=!1)=>{let p=new Date().valueOf(),g=0;const u=new FormData;u.append("file",l);let o={"File-Path":encodeURIComponent(r),"As-Task":c,"Content-Type":"multipart/form-data","Last-Modified":l.lastModified,Password:K(),Overwrite:m.toString()};if(w){const{md5:s,sha1:d,sha256:h}=await Q(l);o["X-File-Md5"]=s,o["X-File-Sha1"]=d,o["X-File-Sha256"]=h}const n=await N.put("/fs/form",u,{headers:o,onUploadProgress:s=>{if(s.total){const d=s.loaded/s.total*100|0;i("progress",d);const h=new Date().valueOf(),$=(h-p)/1e3;if($>1){const y=(s.loaded-g)/$,v=(s.total-s.loaded)/y;i("speed",y),console.log(v),p=h,g=s.loaded}d===100&&i("status","backending")}}});if(n.code!==200)return new Error(n.message)},Ce=async(r,l,i,c=!1,m=!1,w=!1)=>{let p=new Date().valueOf(),g=0,u={"File-Path":encodeURIComponent(r),"As-Task":c,"Content-Type":l.type||"application/octet-stream","Last-Modified":l.lastModified,Password:K(),Overwrite:m.toString()};if(w){const{md5:n,sha1:s,sha256:d}=await Q(l);u["X-File-Md5"]=n,u["X-File-Sha1"]=s,u["X-File-Sha256"]=d}const o=await N.put("/fs/put",l,{headers:u,onUploadProgress:n=>{if(n.total){const s=n.loaded/n.total*100|0;i("progress",s);const d=new Date().valueOf(),h=(d-p)/1e3;if(h>1){const P=(n.loaded-g)/h,S=(n.total-n.loaded)/P;i("speed",P),console.log(S),p=d,g=n.loaded}s===100&&i("status","backending")}}});if(o.code!==200)return new Error(o.message)},De=[{name:"Stream",upload:Ce,provider:/.*/},{name:"Form",upload:Se,provider:/.*/}],Pe=()=>De.filter(r=>r.provider.test(E.provider)),ve=r=>{const l=q();return t(_,{w:"$full",spacing:"$1",rounded:"$lg",border:"1px solid $neutral7",alignItems:"start",p:"$2",get _hover(){return{border:"1px solid ".concat(M())}},get children(){return[t(x,{css:{wordBreak:"break-all"},get children(){return r.path}}),t(I,{spacing:"$2",get children(){return[t(ie,{get colorScheme(){return $e[r.status]},get children(){return l("home.upload.".concat(r.status))}}),t(x,{get children(){return[ce(()=>de(r.speed)),"/s"]}})]}}),t(ue,{w:"$full",trackColor:"$info3",rounded:"$full",get value(){return r.progress},size:"sm",get children(){return t(pe,{get color(){return M()},rounded:"$md"})}}),t(x,{color:"$danger10",get children(){return r.msg}})]}})},Te=()=>{const r=q(),{pathname:l}=ee(),{refresh:i}=te(),[c,m]=D(!1),[w,p]=D(!1),[g,u]=D(!1),[o,n]=D(!1),[s,d]=D(!0),[h,$]=ae({uploads:[]}),P=()=>h.uploads.every(({status:e})=>["success","error"].includes(e));let y,S;const v=async e=>{if(e.length!==0){p(!0);for(const a of e){const b=Fe(a);$("uploads",f=>[...f,b])}for await(const a of be(3,e,Z))console.log(a);i(void 0,!0)}},k=(e,a,b)=>{$("uploads",f=>f.path===e,a,b)},T=Pe(),[O,Y]=D(T[0]),Z=async e=>{const a=e.webkitRelativePath?e.webkitRelativePath:e.name;k(a,"status","uploading");const b=ge(l(),a);try{const f=await O().upload(b,e,(U,A)=>{k(a,U,A)},g(),o(),s());f?(k(a,"status","error"),k(a,"msg",f.message)):(k(a,"status","success"),k(a,"progress",100))}catch(f){console.error(f),k(a,"status","error"),k(a,"msg",f.message)}};return t(_,{w:"$full",pb:"$2",spacing:"$2",get children(){return t(R,{get when(){return!w()},get fallback(){return[t(I,{spacing:"$2",get children(){return[t(J,{colorScheme:"accent",onClick:()=>{$("uploads",e=>e.filter(({status:a})=>!["success","error"].includes(a))),console.log(h.uploads)},get children(){return r("home.upload.clear_done")}}),t(R,{get when(){return P()},get children(){return t(J,{onClick:()=>{p(!1)},get children(){return r("home.upload.back")}})}})]}}),t(le,{get each(){return h.uploads},children:e=>t(ve,e)})]},get children(){return[t(V,{type:"file",multiple:!0,ref(e){var a=y;typeof a=="function"?a(e):y=e},display:"none",onChange:e=>{var a;v(Array.from((a=e.target.files)!=null?a:[]))}}),t(V,{type:"file",multiple:!0,webkitdirectory:!0,ref(e){var a=S;typeof a=="function"?a(e):S=e},display:"none",onChange:e=>{var a;v(Array.from((a=e.target.files)!=null?a:[]))}}),t(_,{w:"$full",justifyContent:"center",get border(){return"2px dashed ".concat(c()?M():"$neutral8")},rounded:"$lg",spacing:"$4",p:"$6",minH:"$56",onDragOver:e=>{e.preventDefault(),m(!0)},onDragLeave:()=>{m(!1)},onDrop:async e=>{var X,B,H,L;e.preventDefault(),e.stopPropagation(),m(!1);const a=[],b=Array.from((B=(X=e.dataTransfer)==null?void 0:X.items)!=null?B:[]),f=Array.from((L=(H=e.dataTransfer)==null?void 0:H.files)!=null?L:[]);let U=b.length;const A=[];for(let C=0;C<U;C++){const F=b[C].webkitGetAsEntry();F!=null&&F.isFile?a.push(f[C]):F!=null&&F.isDirectory&&A.push(F)}for(const C of A){const j=await ye(C);a.push(...j)}a.length===0&&se.warning(r("home.upload.no_files_drag")),v(a)},get children(){return t(R,{get when(){return!c()},get fallback(){return t(W,{get children(){return r("home.upload.release")}})},get children(){return[t(W,{size:"lg",textAlign:"center",get children(){return r("home.upload.upload-tips")}}),t(re,{w:{"@initial":"80%","@md":"30%"},get children(){return t(ne,{get value(){return O().name},onChange:e=>{Y(T.find(a=>a.name===e))},get options(){return T.map(e=>({label:e.name,value:e.name}))}})}}),t(I,{spacing:"$4",get children(){return[t(_,{spacing:"$2",alignItems:"center",get children(){return[t(G,{compact:!0,size:"xl",get"aria-label"(){return r("home.upload.upload_folder")},colorScheme:"accent",get icon(){return t(me,{size:"1.2em"})},onClick:()=>{S.click()}}),t(x,{fontSize:"$sm",color:"$neutral11",textAlign:"center",get children(){return r("home.upload.upload_folder")}})]}}),t(_,{spacing:"$2",alignItems:"center",get children(){return[t(G,{compact:!0,size:"xl",get"aria-label"(){return r("home.upload.upload_files")},get icon(){return t(he,{size:"1.2em"})},onClick:()=>{y.click()}}),t(x,{fontSize:"$sm",color:"$neutral11",textAlign:"center",get children(){return r("home.upload.upload_files")}})]}})]}}),t(oe,{spacing:{"@initial":"$2","@md":"$4"},direction:{"@initial":"column","@md":"row"},get children(){return[t(z,{get checked(){return g()},onChange:()=>{u(!g())},get children(){return r("home.upload.add_as_task")}}),t(z,{get checked(){return o()},onChange:()=>{n(!o())},get children(){return r("home.conflict_policy.overwrite_existing")}}),t(z,{get checked(){return s()},onChange:()=>{d(!s())},get children(){return r("home.upload.try_rapid")}})]}})]}})}})]}})}})};export{Te as default};
